# .github/workflows/dast-scan.yml
# ==========================================
# DAST - Dynamic Application Security Testing
# Using OWASP ZAP for GameVault Frontend
# ==========================================

name: "DAST - Dynamic Security Scan"

on:
  workflow_call:
    inputs:
      target_environment:
        required: false
        default: 'production'
        type: string
  push:
    branches: [prod/master_no_k8s, main]
  schedule:
    - cron: '0 3 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 3 ç‚¹
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'æ‰«æç±»åž‹'
        required: false
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full

env:
  # ç›®æ ‡åº”ç”¨åœ°å€
  ZAP_TARGET_URL: "http://3.0.15.128:3000"
  ZAP_MAX_DURATION: "3"

jobs:
  # ==========================================
  # Job 1: å¥åº·æ£€æŸ¥
  # ==========================================
  health-check:
    name: Application Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Check application availability
        run: |
          echo "ðŸ¥ Checking application health..."
          echo ""
          echo "Target: ${{ env.ZAP_TARGET_URL }}"
          echo ""
          
          # æ£€æŸ¥ä¸»é¡µ
          echo "Testing homepage..."
          if curl -sf "${{ env.ZAP_TARGET_URL }}/" > /dev/null 2>&1; then
            echo "âœ… Homepage accessible"
          else
            echo "âš ï¸  Homepage not responding"
          fi
          
          # æ£€æŸ¥å•†åº—é¡µé¢
          echo "Testing store page..."
          if curl -sf "${{ env.ZAP_TARGET_URL }}/dashboard/store" > /dev/null 2>&1; then
            echo "âœ… Store page accessible"
          else
            echo "âš ï¸  Store page not responding"
          fi
          
          # æ£€æŸ¥è®ºå›é¡µé¢
          echo "Testing forum page..."
          if curl -sf "${{ env.ZAP_TARGET_URL }}/dashboard/forum" > /dev/null 2>&1; then
            echo "âœ… Forum page accessible"
          else
            echo "âš ï¸  Forum page not responding"
          fi
          
          echo ""
          echo "Health check completed"
        continue-on-error: true

  # ==========================================
  # Job 2: OWASP ZAP æ‰«æ
  # ==========================================
  zap-scan:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: health-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x scripts/zap-scan.sh

      - name: Run OWASP ZAP scan
        env:
          ZAP_TARGET_URL: ${{ env.ZAP_TARGET_URL }}
          ZAP_MAX_DURATION: ${{ env.ZAP_MAX_DURATION }}
        run: |
          echo "ðŸ” Starting OWASP ZAP scan..."
          ./scripts/zap-scan.sh
        continue-on-error: true

      - name: Parse ZAP results
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ DAST Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Application:** ${{ env.ZAP_TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "zap_baseline_report.html" ]; then
            HIGH=$(grep -o "FAIL-High" zap_baseline_report.html | wc -l || echo "0")
            MEDIUM=$(grep -o "FAIL-Medium" zap_baseline_report.html | wc -l || echo "0")
            LOW=$(grep -o "FAIL-Low" zap_baseline_report.html | wc -l || echo "0")
            PASS=$(grep -o "PASS" zap_baseline_report.html | wc -l || echo "0")
          
            echo "## ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”µ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            if [ "$HIGH" -gt 0 ]; then
              echo "ðŸš¨ **CRITICAL: $HIGH high severity vulnerabilities detected!**" >> $GITHUB_STEP_SUMMARY
            elif [ "$MEDIUM" -gt 0 ]; then
              echo "âš ï¸ **WARNING: $MEDIUM medium severity vulnerabilities detected.**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **No critical or high vulnerabilities found.**" >> $GITHUB_STEP_SUMMARY
            fi
          
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸŽ¯ Scanned URLs" >> $GITHUB_STEP_SUMMARY
            echo "1. http://3.0.15.128:3000/dashboard/store" >> $GITHUB_STEP_SUMMARY
            echo "2. http://3.0.15.128:3000/dashboard/forum" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Scan report not generated**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-reports
          path: |
            zap_baseline_report.html
            zap-reports/
          retention-days: 30

  # ==========================================
  # Job 3: å®‰å…¨å¤´æ£€æŸ¥
  # ==========================================
  security-headers:
    name: Security Headers Check
    runs-on: ubuntu-latest
    needs: health-check
    if: always()

    steps:
      - name: Check security headers
        run: |
          echo "ðŸ”’ Checking security headers..."
          echo ""
          
          URLS=(
            "http://3.0.15.128:3000/"
            "http://3.0.15.128:3000/dashboard/store"
            "http://3.0.15.128:3000/dashboard/forum"
          )
          
          for URL in "${URLS[@]}"; do
            echo "Checking: $URL"
            echo "---"
          
            RESPONSE=$(curl -sI "$URL" 2>/dev/null || echo "FAILED")
          
            if [ "$RESPONSE" = "FAILED" ]; then
              echo "âš ï¸  Failed to connect"
            else
              # æ£€æŸ¥å¸¸è§å®‰å…¨å¤´
              echo "$RESPONSE" | grep -i "X-Frame-Options" || echo "âš ï¸  X-Frame-Options missing"
              echo "$RESPONSE" | grep -i "X-Content-Type-Options" || echo "âš ï¸  X-Content-Type-Options missing"
              echo "$RESPONSE" | grep -i "Strict-Transport-Security" || echo "âš ï¸  HSTS missing"
              echo "$RESPONSE" | grep -i "Content-Security-Policy" || echo "âš ï¸  CSP missing"
            fi
          
            echo ""
          done
          
          echo "âœ… Security headers check completed"
        continue-on-error: true

      - name: Generate security headers summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Headers Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- http://3.0.15.128:3000/" >> $GITHUB_STEP_SUMMARY
          echo "- http://3.0.15.128:3000/dashboard/store" >> $GITHUB_STEP_SUMMARY
          echo "- http://3.0.15.128:3000/dashboard/forum" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed header information" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 4: æ‰«ææ€»ç»“
  # ==========================================
  dast-summary:
    name: DAST Scan Summary
    runs-on: ubuntu-latest
    needs: [zap-scan, security-headers]
    if: always()

    steps:
      - name: Generate final summary
        run: |
          echo "# ðŸ›¡ï¸ DAST Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** http://3.0.15.128:3000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ZAP Scan | ${{ needs.zap-scan.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Headers | ${{ needs.security-headers.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY