# Security Pipeline - Master (Simplified)
name: "Security Pipeline - Master"

on:
  push:
    branches: [prod/master_no_k8s, main]
  pull_request:
    branches: [prod/master_no_k8s, main]
  workflow_dispatch:
    inputs:
      scan_scope:
        required: true
        default: 'full'
        type: choice
        options: ['full', 'pre-deploy', 'post-deploy', 'quick']

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      run_sast: ${{ steps.determine.outputs.run_sast }}
      run_container: ${{ steps.determine.outputs.run_container }}
      run_dast: ${{ steps.determine.outputs.run_dast }}
    steps:
      - id: determine
        run: |
          echo "run_sast=true" >> $GITHUB_OUTPUT
          echo "run_container=true" >> $GITHUB_OUTPUT
          echo "run_dast=true" >> $GITHUB_OUTPUT
          echo "âœ… Scan plan determined" >> $GITHUB_STEP_SUMMARY

  sast-scan:
    needs: pre-check
    if: needs.pre-check.outputs.run_sast == 'true'
    uses: ./.github/workflows/sast-scan.yml
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit

  container-scan:
    needs: [pre-check, sast-scan]
    if: always() && needs.pre-check.outputs.run_container == 'true'
    uses: ./.github/workflows/container-scan.yml
    permissions:
      contents: read
      security-events: write
      actions: read
      packages: write
    secrets: inherit

  dast-scan:
    needs: [pre-check, container-scan]
    if: always() && needs.pre-check.outputs.run_dast == 'true'
    uses: ./.github/workflows/dast-scan.yml
    permissions:
      contents: read
      security-events: write
      actions: read
    secrets: inherit

  security-gate:
    runs-on: ubuntu-latest
    needs: [sast-scan, container-scan, dast-scan]
    if: always()
    steps:
      - run: |
          echo "ðŸšª Security Gate Check"
          echo "SAST: ${{ needs.sast-scan.result }}"
          echo "Container: ${{ needs.container-scan.result }}"
          echo "DAST: ${{ needs.dast-scan.result }}"
          
          # åªè­¦å‘Šï¼Œä¸é˜»æ­¢
          if [[ "${{ needs.sast-scan.result }}" == "failure" ]]; then
            echo "âš ï¸ SAST had issues (non-blocking)"
          fi
          if [[ "${{ needs.container-scan.result }}" == "failure" ]]; then
            echo "âš ï¸ Container scan had issues (non-blocking)"
          fi
          if [[ "${{ needs.dast-scan.result }}" == "failure" ]]; then
            echo "âš ï¸ DAST had issues (non-blocking)"
          fi
          
          echo "âœ… Security gate: PASSED (warnings only)" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true