# ==========================================
# Master Security Pipeline
# ä¸»å®‰å…¨æ‰«æç¼–æ’ç®¡é“ - åè°ƒæ‰€æœ‰å®‰å…¨æ‰«ææµç¨‹
# ==========================================

name: "Security Pipeline - Master Orchestrator"

on:
  push:
    branches: [prod/master_no_k8s, main]
  pull_request:
    branches: [prod/master_no_k8s, main]
  schedule:
    # æ¯å¤©å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œå®Œæ•´å®‰å…¨æ‰«æ
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      scan_scope:
        description: 'æ‰«æèŒƒå›´'
        required: true
        default: 'full'
        type: choice
        options:
          - 'full'       # å®Œæ•´æ‰«æ (SAST + Container + DAST)
          - 'pre-deploy' # éƒ¨ç½²å‰æ‰«æ (SAST + Container)
          - 'post-deploy'# éƒ¨ç½²åæ‰«æ (DAST only)
          - 'quick'      # å¿«é€Ÿæ‰«æ (ä»…å…³é”®é¡¹)

env:
  SCAN_SCOPE: ${{ github.event.inputs.scan_scope || 'full' }}

jobs:
  # ==========================================
  # Stage 1: å‰ç½®æ£€æŸ¥
  # ==========================================
  pre-check:
    name: Pre-flight Security Check
    runs-on: ubuntu-latest
    outputs:
      should_run_sast: ${{ steps.determine.outputs.run_sast }}
      should_run_container: ${{ steps.determine.outputs.run_container }}
      should_run_dast: ${{ steps.determine.outputs.run_dast }}
    
    steps:
      - name: Determine scan scope
        id: determine
        run: |
          echo "ğŸ” Determining scan scope: ${{ env.SCAN_SCOPE }}"
          
          case "${{ env.SCAN_SCOPE }}" in
            "full")
              echo "run_sast=true" >> $GITHUB_OUTPUT
              echo "run_container=true" >> $GITHUB_OUTPUT
              echo "run_dast=true" >> $GITHUB_OUTPUT
              ;;
            "pre-deploy")
              echo "run_sast=true" >> $GITHUB_OUTPUT
              echo "run_container=true" >> $GITHUB_OUTPUT
              echo "run_dast=false" >> $GITHUB_OUTPUT
              ;;
            "post-deploy")
              echo "run_sast=false" >> $GITHUB_OUTPUT
              echo "run_container=false" >> $GITHUB_OUTPUT
              echo "run_dast=true" >> $GITHUB_OUTPUT
              ;;
            "quick")
              echo "run_sast=true" >> $GITHUB_OUTPUT
              echo "run_container=false" >> $GITHUB_OUTPUT
              echo "run_dast=false" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Display scan plan
        run: |
          echo "## ğŸ” Security Scan Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Static Analysis) | ${{ steps.determine.outputs.run_sast == 'true' && 'âœ… Enabled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ steps.determine.outputs.run_container == 'true' && 'âœ… Enabled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DAST (Dynamic Analysis) | ${{ steps.determine.outputs.run_dast == 'true' && 'âœ… Enabled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Stage 2: SAST é™æ€åˆ†æ
  # ==========================================
  sast-scan:
    name: Run SAST Scan
    needs: pre-check
    if: needs.pre-check.outputs.should_run_sast == 'true'
    uses: ./.github/workflows/enhanced-sast-scan.yml
    secrets: inherit

  # ==========================================
  # Stage 3: å®¹å™¨å®‰å…¨æ‰«æ
  # ==========================================
  container-scan:
    name: Run Container Scan
    needs: [pre-check, sast-scan]
    if: |
      always() && 
      needs.pre-check.outputs.should_run_container == 'true' &&
      (needs.sast-scan.result == 'success' || needs.sast-scan.result == 'skipped')
    uses: ./.github/workflows/enhanced-container-scan.yml
    secrets: inherit

  # ==========================================
  # Stage 4: DAST åŠ¨æ€åˆ†æ
  # ==========================================
  dast-scan:
    name: Run DAST Scan
    needs: [pre-check, container-scan]
    if: |
      always() && 
      needs.pre-check.outputs.should_run_dast == 'true' &&
      (needs.container-scan.result == 'success' || needs.container-scan.result == 'skipped')
    uses: ./.github/workflows/dast-scan.yml
    secrets: inherit

  # ==========================================
  # Stage 5: ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š
  # ==========================================
  generate-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [pre-check, sast-scan, container-scan, dast-scan]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Generate comprehensive security report
        run: |
          echo "# ğŸ” GameVault Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Scan Date:** $(date -u)" >> security-report.md
          echo "**Scan Scope:** ${{ env.SCAN_SCOPE }}" >> security-report.md
          echo "**Triggered By:** ${{ github.event_name }}" >> security-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ğŸ“Š Scan Results Summary" >> security-report.md
          echo "" >> security-report.md
          echo "| Security Stage | Status | Details |" >> security-report.md
          echo "|---------------|--------|---------|" >> security-report.md
          
          # SAST Results
          SAST_STATUS="${{ needs.sast-scan.result }}"
          case "$SAST_STATUS" in
            "success") SAST_ICON="âœ…" ;;
            "failure") SAST_ICON="âŒ" ;;
            "skipped") SAST_ICON="â­ï¸" ;;
            *) SAST_ICON="â“" ;;
          esac
          echo "| SAST (Static Analysis) | $SAST_ICON $SAST_STATUS | Code quality, dependencies, vulnerabilities |" >> security-report.md
          
          # Container Scan Results
          CONTAINER_STATUS="${{ needs.container-scan.result }}"
          case "$CONTAINER_STATUS" in
            "success") CONTAINER_ICON="âœ…" ;;
            "failure") CONTAINER_ICON="âŒ" ;;
            "skipped") CONTAINER_ICON="â­ï¸" ;;
            *) CONTAINER_ICON="â“" ;;
          esac
          echo "| Container Security | $CONTAINER_ICON $CONTAINER_STATUS | Docker image vulnerabilities, configs |" >> security-report.md
          
          # DAST Results
          DAST_STATUS="${{ needs.dast-scan.result }}"
          case "$DAST_STATUS" in
            "success") DAST_ICON="âœ…" ;;
            "failure") DAST_ICON="âŒ" ;;
            "skipped") DAST_ICON="â­ï¸" ;;
            *) DAST_ICON="â“" ;;
          esac
          echo "| DAST (Dynamic Analysis) | $DAST_ICON $DAST_STATUS | Runtime security, API testing |" >> security-report.md
          
          echo "" >> security-report.md
          
          # Overall Assessment
          if [[ "$SAST_STATUS" == "failure" || "$CONTAINER_STATUS" == "failure" || "$DAST_STATUS" == "failure" ]]; then
            echo "## âš ï¸ Security Issues Detected" >> security-report.md
            echo "" >> security-report.md
            echo "**CRITICAL:** Security vulnerabilities have been detected. Please review the detailed reports." >> security-report.md
          else
            echo "## âœ… Security Scan Passed" >> security-report.md
            echo "" >> security-report.md
            echo "**GOOD:** No critical security issues detected in this scan." >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## ğŸ“ Detailed Reports" >> security-report.md
          echo "" >> security-report.md
          echo "All detailed scan reports are available in the workflow artifacts:" >> security-report.md
          echo "- [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> security-report.md

      - name: Display report in summary
        run: cat security-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-report
          path: |
            security-report.md
            security-reports/
          retention-days: 90

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ==========================================
  # Stage 6: å®‰å…¨é—¨ç¦æ£€æŸ¥
  # ==========================================
  security-gate:
    name: Security Quality Gate
    runs-on: ubuntu-latest
    needs: [sast-scan, container-scan, dast-scan]
    if: always()
    
    steps:
      - name: Check security gate
        run: |
          echo "ğŸšª Checking Security Quality Gate..."
          
          SAST_RESULT="${{ needs.sast-scan.result }}"
          CONTAINER_RESULT="${{ needs.container-scan.result }}"
          DAST_RESULT="${{ needs.dast-scan.result }}"
          
          echo "SAST: $SAST_RESULT"
          echo "Container: $CONTAINER_RESULT"
          echo "DAST: $DAST_RESULT"
          
          # é—¨ç¦è§„åˆ™ï¼šå¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œåˆ™é˜»æ­¢
          if [[ "$SAST_RESULT" == "failure" ]]; then
            echo "âŒ SAST scan failed - Security gate: BLOCKED"
            exit 1
          fi
          
          if [[ "$CONTAINER_RESULT" == "failure" ]]; then
            echo "âŒ Container scan failed - Security gate: BLOCKED"
            exit 1
          fi
          
          if [[ "$DAST_RESULT" == "failure" ]]; then
            echo "âš ï¸ DAST scan failed - Security gate: WARNING (not blocking)"
            # DAST å¤±è´¥ä¸é˜»æ­¢ï¼ˆå› ä¸ºå¯èƒ½æ˜¯ç¯å¢ƒé—®é¢˜ï¼‰
          fi
          
          echo "âœ… Security Quality Gate: PASSED"

      - name: Send notification
        if: failure()
        run: |
          echo "ğŸ“¢ Sending security gate failure notification..."
          # è¿™é‡Œå¯ä»¥é›†æˆ Slack, Email, ç­‰é€šçŸ¥ç³»ç»Ÿ
          echo "Security scan failed. Please check the reports."