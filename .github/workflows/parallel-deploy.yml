name: "Parallel Deploy - All Services"

# è¿™ä¸ªworkflowå¯ä»¥å¹¶è¡Œæž„å»ºå’Œéƒ¨ç½²å¤šä¸ªæœåŠ¡
# ç±»ä¼¼K8Sçš„å¤šç®¡é“éƒ¨ç½²æ–¹å¼

on:
  # âœ… æ·»åŠ  push è§¦å‘å™¨ - æŽ¨é€åˆ°æŒ‡å®šåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - prod/master_no_k8s
      - main
      - master
    # å¯é€‰ï¼šåªåœ¨ç‰¹å®šè·¯å¾„å˜æ›´æ—¶è§¦å‘
    # paths:
    #   - 'gamevault-*/**'
    #   - '.github/workflows/parallel-deploy.yml'

  # âœ… ä¿ç•™æ‰‹åŠ¨è§¦å‘å™¨ - å¯ä»¥æ‰‹åŠ¨é€‰æ‹©è¦éƒ¨ç½²çš„æœåŠ¡
  workflow_dispatch:
    inputs:
      services:
        description: 'é€‰æ‹©è¦éƒ¨ç½²çš„æœåŠ¡ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'gateway,auth,shopping,forum,developer,social'
        type: string
      deploy:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°EC2'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ==================== Job 1: å‡†å¤‡å·¥ä½œ - å®‰è£…çˆ¶POMå’ŒCommonæ¨¡å— ====================
  prepare-common:
    runs-on: ubuntu-latest
    name: Prepare Parent POM and Common Module

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Parent POM
        run: |
          echo "ðŸ“¦ Installing parent POM (gamevault-cloud)..."
          # åªå®‰è£…çˆ¶ POMï¼Œä¸æž„å»ºå­æ¨¡å—
          mvn install -N -DskipTests -B
          echo "âœ… Parent POM installed"

      - name: Build and Install Common Module
        run: |
          if [ -d "gamevault-common" ]; then
            echo "ðŸ“¦ Building gamevault-common module..."
            cd gamevault-common
            mvn clean install -DskipTests -B
            echo "âœ… Common module installed"
          else
            echo "âš ï¸  No common module found, skipping..."
          fi

      - name: Verify Installation
        run: |
          echo "ðŸ” Verifying installed artifacts..."
          ls -la ~/.m2/repository/com/sg/nusiss/gamevault-cloud/ || echo "Parent POM not found"
          ls -la ~/.m2/repository/com/sg/nusiss/gamevault-common/ || echo "Common module not found"

      - name: Cache Maven Repository
        uses: actions/cache/save@v3
        with:
          path: ~/.m2/repository
          key: maven-common-${{ github.sha }}

  # ==================== Job 2: å¹¶è¡Œæž„å»ºæ‰€æœ‰æœåŠ¡ ====================
  build-services:
    runs-on: ubuntu-latest
    needs: prepare-common
    name: Build ${{ matrix.service }}

    strategy:
      fail-fast: false
      matrix:
        service:
          - gateway
          - auth
          - shopping
          - forum
          - developer
          - social
        include:
          - service: gateway
            port: 8080
            needs_redis: false
          - service: auth
            port: 8081
            needs_redis: false
          - service: shopping
            port: 8082
            needs_redis: false
          - service: forum
            port: 8083
            needs_redis: false
          - service: developer
            port: 8084
            needs_redis: true
          - service: social
            port: 8089
            needs_redis: true

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: gamevault_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # âœ… åœ¨ step å±‚é¢åˆ¤æ–­æ˜¯å¦åº”è¯¥æž„å»ºæ­¤æœåŠ¡
      - name: Check if service should be built
        id: check
        run: |
          # å¦‚æžœæ˜¯ push è§¦å‘ï¼Œæž„å»ºæ‰€æœ‰æœåŠ¡
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… Push trigger: building all services"
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®è¾“å…¥å‚æ•°åˆ¤æ–­
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"
            SERVICE="${{ matrix.service }}"
          
            if echo "$SERVICES" | grep -q "$SERVICE"; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "âœ… Service $SERVICE is selected for build"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  Service $SERVICE is NOT selected, skipping..."
            fi
          fi

      - name: Checkout code
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Set up JDK 17
        if: steps.check.outputs.should_build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Restore Maven Cache
        if: steps.check.outputs.should_build == 'true'
        uses: actions/cache/restore@v3
        with:
          path: ~/.m2/repository
          key: maven-common-${{ github.sha }}

      - name: Build Service
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "ðŸ”¨ Building gamevault-${{ matrix.service }}..."
          cd gamevault-${{ matrix.service }}
          mvn clean package -DskipTests -B

      - name: Run Tests
        if: steps.check.outputs.should_build == 'true'
        run: |
          cd gamevault-${{ matrix.service }}
          mvn test -B
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/gamevault_test
          SPRING_DATASOURCE_USERNAME: test_user
          SPRING_DATASOURCE_PASSWORD: test_password
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379

      - name: Upload JAR
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: gamevault-${{ matrix.service }}/target/*.jar
          retention-days: 1

      - name: Build Summary
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "âœ… Built gamevault-${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY

  # ==================== Job 3: å¹¶è¡Œæž„å»ºå’ŒæŽ¨é€Dockeré•œåƒ ====================
  build-images:
    runs-on: ubuntu-latest
    needs: build-services
    name: Build Image - ${{ matrix.service }}
    environment: production

    strategy:
      fail-fast: false
      matrix:
        service:
          - gateway
          - auth
          - shopping
          - forum
          - developer
          - social
        include:
          - service: gateway
            port: 8080
          - service: auth
            port: 8081
          - service: shopping
            port: 8082
          - service: forum
            port: 8083
          - service: developer
            port: 8084
          - service: social
            port: 8089

    steps:
      # âœ… åœ¨ step å±‚é¢åˆ¤æ–­æ˜¯å¦åº”è¯¥æž„å»ºæ­¤æœåŠ¡çš„é•œåƒ
      - name: Check if service should be built
        id: check
        run: |
          # å¦‚æžœæ˜¯ push è§¦å‘ï¼Œæž„å»ºæ‰€æœ‰æœåŠ¡
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… Push trigger: building all images"
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®è¾“å…¥å‚æ•°åˆ¤æ–­
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"
            SERVICE="${{ matrix.service }}"
          
            if echo "$SERVICES" | grep -q "$SERVICE"; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "âœ… Service $SERVICE is selected for image build"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  Service $SERVICE is NOT selected, skipping..."
            fi
          fi

      - name: Checkout code
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Set up JDK 17
        if: steps.check.outputs.should_build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Restore Maven Cache
        if: steps.check.outputs.should_build == 'true'
        uses: actions/cache/restore@v3
        with:
          path: ~/.m2/repository
          key: maven-common-${{ github.sha }}

      - name: Download JAR
        if: steps.check.outputs.should_build == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: gamevault-${{ matrix.service }}/target/

      - name: Set up Docker Buildx
        if: steps.check.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: steps.check.outputs.should_build == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        if: steps.check.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./gamevault-${{ matrix.service }}
          file: ./gamevault-${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/gamevault-${{ matrix.service }}:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/gamevault-${{ matrix.service }}:latest
          platforms: linux/amd64
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/gamevault-${{ matrix.service }}:latest
          cache-to: type=inline

      - name: Image Summary
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "âœ… Built and pushed gamevault-${{ matrix.service }}:latest" >> $GITHUB_STEP_SUMMARY

  # ==================== Job 4: å¹¶è¡Œéƒ¨ç½²åˆ°EC2 ====================
  deploy-services:
    runs-on: ubuntu-latest
    needs: build-images
    name: Deploy - ${{ matrix.service }}
    # âœ… Push è§¦å‘æ—¶è‡ªåŠ¨éƒ¨ç½²ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶æ ¹æ® deploy å‚æ•°å†³å®š
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    environment: production

    strategy:
      max-parallel: 3
      fail-fast: false
      matrix:
        service:
          - gateway
          - auth
          - shopping
          - forum
          - developer
          - social
        include:
          - service: gateway
            port: 8080
          - service: auth
            port: 8081
          - service: shopping
            port: 8082
          - service: forum
            port: 8083
          - service: developer
            port: 8084
          - service: social
            port: 8089

    steps:
      # âœ… åœ¨ step å±‚é¢åˆ¤æ–­æ˜¯å¦åº”è¯¥éƒ¨ç½²æ­¤æœåŠ¡
      - name: Check if service should be deployed
        id: check
        run: |
          # å¦‚æžœæ˜¯ push è§¦å‘ï¼Œéƒ¨ç½²æ‰€æœ‰æœåŠ¡
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Push trigger: deploying all services"
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®è¾“å…¥å‚æ•°åˆ¤æ–­
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"
            SERVICE="${{ matrix.service }}"
          
            if echo "$SERVICES" | grep -q "$SERVICE"; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… Service $SERVICE is selected for deployment"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  Service $SERVICE is NOT selected, skipping deployment..."
            fi
          fi

      - name: Configure SSH
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy ${{ matrix.service }} to EC2
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash -s << 'ENDSSH'
          cd ~/gamevault-cloud
          
          SERVICE="${{ matrix.service }}"
          echo "ðŸš€ Deploying $SERVICE service..."
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/gamevault-$SERVICE:latest
          
          # åœæ­¢æ—§å®¹å™¨
          sudo docker compose stop $SERVICE
          sudo docker compose rm -f $SERVICE
          
          # å¯åŠ¨æ–°å®¹å™¨
          sudo docker compose up -d $SERVICE
          
          # ç­‰å¾…å¯åŠ¨
          echo "â³ Waiting for $SERVICE to start..."
          sleep 30
          
          # æ£€æŸ¥çŠ¶æ€
          if sudo docker compose ps $SERVICE | grep -q "Up"; then
            echo "âœ… $SERVICE deployed successfully"
            sudo docker compose logs $SERVICE --tail=30
          else
            echo "âŒ $SERVICE failed to start"
            sudo docker compose logs $SERVICE --tail=50
            exit 1
          fi
          ENDSSH

      - name: Health Check
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash -s << 'ENDSSH'
          SERVICE="${{ matrix.service }}"
          PORT="${{ matrix.port }}"
          
          echo "ðŸ¥ Health check for $SERVICE..."
          sleep 10
          
          if curl -f http://localhost:$PORT/actuator/health 2>/dev/null; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸  Health check failed (might be normal for some services)"
          fi
          
          # æ£€æŸ¥Nacosæ³¨å†Œ
          if curl -s "http://localhost:8848/nacos/v1/ns/instance/list?serviceName=gamevault-$SERVICE" | grep -q "hosts"; then
            echo "âœ… Registered in Nacos"
          else
            echo "âš ï¸  Not yet registered in Nacos"
          fi
          ENDSSH

      - name: Cleanup
        if: always() && steps.check.outputs.should_deploy == 'true'
        run: rm -f ~/.ssh/ec2_key

      - name: Deployment Summary
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          echo "âœ… Deployed ${{ matrix.service }} successfully" >> $GITHUB_STEP_SUMMARY

  # ==================== Job 5: æœ€ç»ˆéªŒè¯ ====================
  final-verification:
    runs-on: ubuntu-latest
    needs: deploy-services
    name: Final Verification
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    environment: production

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Verify All Services
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash -s << 'ENDSSH'
          cd ~/gamevault-cloud
          
          echo "=========================================="
          echo "ðŸ“Š Final Service Status Check"
          echo "=========================================="
          
          sudo docker compose ps
          
          echo ""
          echo "=========================================="
          echo "ðŸ” Nacos Registration Check"
          echo "=========================================="
          
          # å¦‚æžœæ˜¯ push è§¦å‘ï¼Œæ£€æŸ¥æ‰€æœ‰æœåŠ¡
          if [ "${{ github.event_name }}" = "push" ]; then
            SERVICES="gateway auth shopping forum developer social"
          else
            SERVICES="${{ github.event.inputs.services }}"
          fi
          
          for service in $(echo $SERVICES | tr ',' ' '); do
            echo -n "Checking gamevault-$service: "
            if curl -s "http://localhost:8848/nacos/v1/ns/instance/list?serviceName=gamevault-$service" | grep -q "hosts"; then
              echo "âœ… Registered"
            else
              echo "âŒ Not registered"
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "ðŸ§¹ Cleanup Old Images"
          echo "=========================================="
          sudo docker image prune -f
          
          echo ""
          echo "âœ… Deployment Complete!"
          ENDSSH

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/ec2_key

      - name: Final Summary
        run: |
          echo "## ðŸŽ‰ Parallel Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "**Trigger**: Push to ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "**Deployed Services**: All services" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Trigger**: Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
            echo "**Deployed Services**: ${{ github.event.inputs.services }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- Nacos Console: http://${{ secrets.EC2_HOST }}:8848/nacos" >> $GITHUB_STEP_SUMMARY
          echo "- Gateway: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY