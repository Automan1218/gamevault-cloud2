# SAST - Complete Security Scan
name: "SAST - Complete Security Scan"

on:
  workflow_call:
    inputs:
      scan_level:
        required: false
        default: 'full'
        type: string
  push:
    branches: ['**']
  pull_request:
    branches: [prod/master_no_k8s, dev/master, main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  JAVA_VERSION: '17'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    name: Dependency Security Check

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ç¼“å­˜ OWASP æ•°æ®åº“
      - name: Cache OWASP Database
        id: cache-owasp-db
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository/org/owasp/dependency-check-data
            ~/.m2/repository/org/owasp/dependency-check-utils
          key: ${{ runner.os }}-owasp-db-v2-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-owasp-db-v2-
            ${{ runner.os }}-owasp-db-

      # é¦–æ¬¡è¿è¡Œï¼šåˆå§‹åŒ–æ•°æ®åº“
      - name: Initialize OWASP Database (First Run)
        if: steps.cache-owasp-db.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ“¥ First run detected - initializing database..."
          echo "This may take 5-10 minutes..."
          
          # ä½¿ç”¨ update-only åˆå§‹åŒ–æ•°æ®åº“
          mvn org.owasp:dependency-check-maven:9.0.9:update-only \
            -B \
            -Dformat=ALL \
            2>&1 | tee update.log
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ -d "$HOME/.m2/repository/org/owasp/dependency-check-data" ]; then
            echo "âœ… Database initialized successfully"
            ls -la "$HOME/.m2/repository/org/owasp/dependency-check-data/"
          else
            echo "âš ï¸ Database initialization may have failed"
            cat update.log
          fi
        continue-on-error: true
        timeout-minutes: 15

      # æž„å»ºé¡¹ç›®
      - name: Build Project
        run: |
          echo "ðŸ”¨ Building project..."
          if [ -d "gamevault-common" ]; then
            cd gamevault-common && mvn clean install -DskipTests -B && cd ..
          fi
          mvn clean compile -B

      # è¿è¡Œä¾èµ–æ£€æŸ¥
      - name: Run Dependency Check
        run: |
          echo "ðŸ” Running dependency check..."
          
          # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
          DB_PATH="$HOME/.m2/repository/org/owasp/dependency-check-data"
          
          if [ -d "$DB_PATH" ] && [ "$(ls -A $DB_PATH 2>/dev/null)" ]; then
            echo "âœ… Using cached database"
            AUTO_UPDATE="false"
          else
            echo "âš ï¸ Database not found, enabling auto-update"
            AUTO_UPDATE="true"
          fi
          
          echo "Running scan with autoUpdate=$AUTO_UPDATE"
          
          mvn org.owasp:dependency-check-maven:9.0.9:check \
            -DskipTests \
            -DfailBuildOnCVSS=11 \
            -DautoUpdate=$AUTO_UPDATE \
            -DcentralAnalyzerEnabled=false \
            -DassemblyAnalyzerEnabled=false \
            -DsuppressionFile=dependency-check-suppression.xml \
            -B \
            2>&1 | tee check.log || echo "âš ï¸ Check completed with warnings"
          
          echo "âœ… Scan completed"
        continue-on-error: true
        timeout-minutes: 20

      # ç”Ÿæˆæ‘˜è¦
      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ”’ Dependency Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Cache Hit:** ${{ steps.cache-owasp-db.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾æŠ¥å‘Š
          REPORTS=$(find . -name "dependency-check-report.html" -type f 2>/dev/null)
          
          if [ -n "$REPORTS" ]; then
            echo "âœ… Vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reports generated:**" >> $GITHUB_STEP_SUMMARY
            echo "$REPORTS" | while read report; do
              echo "- \`$report\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "â„¹ï¸ No reports generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # æ˜¾ç¤ºæ—¥å¿—æ‘˜è¦
            if [ -f "check.log" ]; then
              echo "**Log excerpt:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -20 check.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

      # ä¸Šä¼ æŠ¥å‘Š
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            **/target/dependency-check-report.*
            check.log
            update.log
          if-no-files-found: ignore
          retention-days: 30

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build for CodeQL
        run: |
          if [ -d "gamevault-common" ]; then
            cd gamevault-common && mvn clean install -DskipTests -B && cd ..
          fi
          mvn clean compile -B

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3