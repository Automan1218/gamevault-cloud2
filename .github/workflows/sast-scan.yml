# ==========================================
# Enhanced SAST Security Scan Workflow
# ÈùôÊÄÅÂ∫îÁî®ÂÆâÂÖ®ÊµãËØï - ÈõÜÊàêÂ§öÁßçÊâ´ÊèèÂ∑•ÂÖ∑
# ÈÄÇÁî®‰∫é GameVault ÂæÆÊúçÂä°Êû∂ÊûÑ
# ==========================================

name: "SAST - Complete Security Scan"

on:
  workflow_call:  # ÂøÖÈ°ªÊîæÂú®ÊúÄÂâçÈù¢ÔºÅ
    inputs:
      scan_level:
        description: 'Êâ´ÊèèÁ∫ßÂà´'
        required: false
        default: 'full'
        type: string
  push:
    branches: ['**']
  pull_request:
    branches: [prod/master_no_k8s, dev/master, main]
  schedule:
    # ÊØèÂë®‰∏ÄÂáåÊô® 2 ÁÇπËá™Âä®Êâ´Êèè
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      scan_level:
        description: 'Êâ´ÊèèÁ∫ßÂà´'
        required: true
        default: 'full'
        type: choice
        options:
          - 'quick'    # Âø´ÈÄüÊâ´Êèè
          - 'full'     # ÂÆåÊï¥Êâ´Êèè
          - 'critical' # ‰ªÖÂÖ≥ÈîÆÊºèÊ¥û

# permissions Áî±Ë∞ÉÁî®ÊñπÔºà‰∏ªÁÆ°ÈÅìÔºâÊèê‰æõ
# permissions:
#   contents: read
#   security-events: write
#   actions: read
#   pull-requests: write

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx3g'

jobs:
  # ==========================================
  # Job 1: ‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü• (Linting)
  # ==========================================
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Install dependencies
        run: |
          echo "üì¶ Building common module first..."
          # ÂÖàÊûÑÂª∫Âπ∂ÂÆâË£Ö common Ê®°ÂùóÂà∞Êú¨Âú∞‰ªìÂ∫ì
          if [ -d "gamevault-common" ]; then
            cd gamevault-common
            mvn clean install -DskipTests -B
            cd ..
          fi
          # ÂÜçÊûÑÂª∫Êï¥‰∏™È°πÁõÆ
          mvn dependency:go-offline -B

      - name: Run Checkstyle
        run: |
          echo "üîç Running Checkstyle..."
          chmod +x scripts/checkstyle.sh
          ./scripts/checkstyle.sh || true
        continue-on-error: true

      - name: Run SpotBugs
        run: |
          echo "üêõ Running SpotBugs..."
          chmod +x scripts/spotbugs.sh
          ./scripts/spotbugs.sh || true
        continue-on-error: true

      - name: Run PMD
        run: |
          echo "üìä Running PMD..."
          mvn pmd:pmd pmd:cpd || true
        continue-on-error: true

      - name: Generate Quality Report
        if: always()
        run: |
          echo "## üìã Code Quality Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Checkstyle
          if [ -f "target/checkstyle-result.xml" ]; then
            VIOLATIONS=$(grep -c "<error" target/checkstyle-result.xml || echo "0")
            echo "### ‚úÖ Checkstyle" >> $GITHUB_STEP_SUMMARY
            echo "- Violations: **$VIOLATIONS**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # SpotBugs
          if [ -f "target/spotbugsXml.xml" ]; then
            BUGS=$(grep -c "<BugInstance" target/spotbugsXml.xml || echo "0")
            echo "### üêõ SpotBugs" >> $GITHUB_STEP_SUMMARY
            echo "- Potential Bugs: **$BUGS**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PMD
          if [ -f "target/pmd.xml" ]; then
            PMD_ISSUES=$(grep -c "<violation" target/pmd.xml || echo "0")
            echo "### üìä PMD" >> $GITHUB_STEP_SUMMARY
            echo "- Code Quality Issues: **$PMD_ISSUES**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Quality Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            target/checkstyle-result.xml
            target/spotbugsXml.xml
            target/spotbugs-report.html
            target/pmd.xml
            target/site/
          retention-days: 30

  # ==========================================
  # Job 2: OWASP ‰æùËµñÊºèÊ¥ûÊ£ÄÊü•
  # ==========================================
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache OWASP Database
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-owasp-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-owasp-

      - name: Download OWASP Dependency Check
        run: |
          echo "üì• Downloading OWASP Dependency Check..."
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip -q dependency-check-9.0.9-release.zip
          chmod +x dependency-check/bin/dependency-check.sh

      - name: Create suppression file if not exists
        run: |
          if [ ! -f "dependency-check-suppression.xml" ]; then
            cat > dependency-check-suppression.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd">
              <!-- Âú®ËøôÈáåÊ∑ªÂä†ÈúÄË¶ÅÊäëÂà∂ÁöÑÊºèÊ¥û -->
          </suppressions>
          EOF
          fi

      - name: Run OWASP Dependency Check
        env:
          NVD_API_KEY: ${{ secrets.NVD_TOKEN }}
        run: |
          echo "üîç Running OWASP Dependency Check..."
          ./dependency-check/bin/dependency-check.sh \
            --project "GameVault Microservices" \
            --scan . \
            --format HTML \
            --format JSON \
            --format XML \
            --out ./dependency-check-report \
            --suppression ./dependency-check-suppression.xml \
            --nvdApiKey "${NVD_API_KEY:-}" \
            --enableExperimental \
            --failOnCVSS 7 || true
        continue-on-error: true

      - name: Parse and Report Vulnerabilities
        if: always()
        run: |
          echo "## üõ°Ô∏è OWASP Dependency Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "./dependency-check-report/dependency-check-report.json" ]; then
            CRITICAL=$(grep -o '"severity":"CRITICAL"' ./dependency-check-report/dependency-check-report.json | wc -l || echo "0")
            HIGH=$(grep -o '"severity":"HIGH"' ./dependency-check-report/dependency-check-report.json | wc -l || echo "0")
            MEDIUM=$(grep -o '"severity":"MEDIUM"' ./dependency-check-report/dependency-check-report.json | wc -l || echo "0")
            LOW=$(grep -o '"severity":"LOW"' ./dependency-check-report/dependency-check-report.json | wc -l || echo "0")

            echo "### ÊºèÊ¥ûÁªüËÆ°:" >> $GITHUB_STEP_SUMMARY
            echo "| ‰∏•ÈáçÁ®ãÂ∫¶ | Êï∞Èáè |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
            echo "**ÊÄªËÆ°: $TOTAL ‰∏™ÊºèÊ¥û**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ö†Ô∏è **ÂèëÁé∞‰∏•ÈáçÊºèÊ¥û! ÈúÄË¶ÅÁ´ãÂç≥Â§ÑÁêÜ!**" >> $GITHUB_STEP_SUMMARY
            elif [ "$HIGH" -gt 0 ]; then
              echo "‚ö†Ô∏è **ÂèëÁé∞È´òÂç±ÊºèÊ¥ûÔºåËØ∑Â∞ΩÂø´‰øÆÂ§ç„ÄÇ**" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ **Êú™ÂèëÁé∞‰∏•ÈáçÊàñÈ´òÂç±ÊºèÊ¥û„ÄÇ**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è Êä•ÂëäÊú™ÁîüÊàê" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload OWASP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: ./dependency-check-report/
          retention-days: 30

  # ==========================================
  # Job 3: GitHub CodeQL ÂàÜÊûê
  # ==========================================
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod/master_no_k8s' || github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        language: ['java']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: |
          # ÂÖàÊûÑÂª∫ common Ê®°Âùó
          if [ -d "gamevault-common" ]; then
            cd gamevault-common
            mvn clean install -DskipTests -B
            cd ..
          fi
          # ÂÜçÊûÑÂª∫Êï¥‰∏™È°πÁõÆ
          mvn clean compile -B -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # ==========================================
  # Job 4: Snyk ‰æùËµñÂíå‰ª£Á†ÅÊâ´Êèè
  # ==========================================
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Install dependencies
        run: mvn dependency:resolve

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --all-projects

      - name: Upload Snyk result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request'
        continue-on-error: true
        with:
          sarif_file: snyk.sarif

  # ==========================================
  # Job 5: ÂÆâÂÖ®Êâ´ÊèèÊ±áÊÄªÊä•Âëä
  # ==========================================
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-check, codeql-analysis]
    if: always()
    
    steps:
      - name: Generate Security Summary
        run: |
          echo "# üîê Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Êâ´ÊèèÂÆåÊàêÊÉÖÂÜµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Êâ´ÊèèÈ°πÁõÆ | Áä∂ÊÄÅ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Dependency Check | ${{ needs.dependency-check.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Êü•ÁúãËØ¶ÁªÜÊä•ÂëäËØ∑ËÆøÈóÆ: [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Check for critical failures
        if: needs.dependency-check.result == 'failure' || needs.codeql-analysis.result == 'failure'
        run: |
          echo "‚ö†Ô∏è Critical security issues detected!"
          exit 1