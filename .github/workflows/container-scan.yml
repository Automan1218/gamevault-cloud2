# ==========================================
# Enhanced Container Security Scan Workflow
# Docker ÈïúÂÉèÂíåÂÆπÂô®ÂÆâÂÖ®Êâ´Êèè
# ÈÄÇÁî®‰∫é GameVault ÂæÆÊúçÂä°Êû∂ÊûÑ
# ==========================================

name: "Container Scan - Docker Security"

on:
  workflow_call:  # ÂøÖÈ°ªÊîæÂú®ÊúÄÂâçÈù¢ÔºÅ
    inputs:
      scan_all_services:
        description: 'ÊòØÂê¶Êâ´ÊèèÊâÄÊúâÊúçÂä°'
        required: false
        default: true
        type: boolean
  push:
    branches: ['**']
  pull_request:
    branches: [prod/master_no_k8s, dev/master, main]
  schedule:
    # ÊØèÂë®‰∏ÄÂáåÊô® 4 ÁÇπËá™Âä®Êâ´Êèè
    - cron: '0 4 * * 1'
  workflow_dispatch:
    inputs:
      scan_all_services:
        description: 'ÊòØÂê¶Êâ´ÊèèÊâÄÊúâÊúçÂä°'
        required: true
        default: 'true'
        type: boolean

# permissions Áî±Ë∞ÉÁî®ÊñπÔºà‰∏ªÁÆ°ÈÅìÔºâÊèê‰æõ
# permissions:
#   contents: read
#   security-events: write
#   packages: write
#   actions: read

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_TAG: latest

jobs:
  # ==========================================
  # Job 1: ÊûÑÂª∫ Docker ÈïúÂÉè
  # ==========================================
  build-images:
    name: Build Docker Images for Scanning
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        service:
          - gamevault-gateway
          - gamevault-auth
          - gamevault-shopping
          - gamevault-forum
          - gamevault-developer
          - gamevault-social

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR
        run: |
          echo "üî® Building ${{ matrix.service }}..."
          # ÂÖàÊûÑÂª∫ common Ê®°Âùó
          if [ -d "gamevault-common" ]; then
            cd gamevault-common
            mvn clean install -DskipTests -B
            cd ..
          fi
          # ÂÜçÊûÑÂª∫Êï¥‰∏™È°πÁõÆ
          mvn clean package -DskipTests -B

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          load: true
          tags: ${{ matrix.service }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker Image
        run: |
          docker save ${{ matrix.service }}:scan | gzip > ${{ matrix.service }}-scan.tar.gz

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: ${{ matrix.service }}-scan.tar.gz
          retention-days: 1

  # ==========================================
  # Job 2: Trivy ÂÆπÂô®Êâ´Êèè
  # ==========================================
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: build-images

    strategy:
      fail-fast: false
      matrix:
        service:
          - gamevault-gateway
          - gamevault-auth
          - gamevault-shopping
          - gamevault-forum
          - gamevault-developer
          - gamevault-social

    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}

      - name: Load Docker Image
        run: |
          docker load < ${{ matrix.service }}-scan.tar.gz

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,config,secret'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request'  # ‰ªÖÂú®Èùû PR Êó∂‰∏ä‰º†
        continue-on-error: true  # Â¶ÇÊûúÂ§±Ë¥•‰∏çÂΩ±ÂìçÊï¥‰ΩìÊµÅÁ®ã
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: trivy-${{ matrix.service }}

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: 'json'
          output: 'trivy-${{ matrix.service }}.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln,config,secret'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Parse Trivy Results
        if: always()
        run: |
          echo "## üê≥ Trivy Scan Results - ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "trivy-${{ matrix.service }}.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-${{ matrix.service }}.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-${{ matrix.service }}.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-${{ matrix.service }}.json)
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-${{ matrix.service }}.json)
          
            echo "### ÊºèÊ¥ûÁªüËÆ°:" >> $GITHUB_STEP_SUMMARY
            echo "| ‰∏•ÈáçÁ®ãÂ∫¶ | Êï∞Èáè |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ö†Ô∏è **ÂèëÁé∞‰∏•ÈáçÊºèÊ¥û!**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Trivy Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-${{ matrix.service }}
          path: |
            trivy-${{ matrix.service }}.sarif
            trivy-${{ matrix.service }}.json
          retention-days: 30

  # ==========================================
  # Job 3: Docker Scout Êâ´Êèè
  # ==========================================
  docker-scout-scan:
    name: Docker Scout Security Scan
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name != 'pull_request'

    strategy:
      fail-fast: false
      matrix:
        service:
          - gamevault-gateway
          - gamevault-auth
          - gamevault-shopping
          - gamevault-forum
          - gamevault-developer
          - gamevault-social

    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}

      - name: Load Docker Image
        run: |
          docker load < ${{ matrix.service }}-scan.tar.gz

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Scout - CVE Scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ matrix.service }}:scan
          only-severities: critical,high
          exit-code: false
          summary: true

      - name: Docker Scout - Recommendations
        uses: docker/scout-action@v1
        with:
          command: recommendations
          image: ${{ matrix.service }}:scan
          exit-code: false

      - name: Docker Scout - SBOM
        uses: docker/scout-action@v1
        with:
          command: sbom
          image: ${{ matrix.service }}:scan
          output: scout-sbom-${{ matrix.service }}.json
          format: json

      - name: Upload Scout Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scout-report-${{ matrix.service }}
          path: scout-sbom-${{ matrix.service }}.json
          retention-days: 30

  # ==========================================
  # Job 5: Âü∫Á°ÄÈïúÂÉèÂÆâÂÖ®Ê£ÄÊü•
  # ==========================================
  base-image-check:
    name: Base Image Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check base image versions
        run: |
          echo "## üì¶ Base Image Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Base Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          SERVICES=(
            "gamevault-gateway"
            "gamevault-auth"
            "gamevault-shopping"
            "gamevault-forum"
            "gamevault-developer"
            "gamevault-social"
          )
          
          for service in "${SERVICES[@]}"; do
            if [ -f "$service/Dockerfile" ]; then
              BASE_IMAGE=$(grep "^FROM" "$service/Dockerfile" | head -n1 | awk '{print $2}')
              echo "| $service | $BASE_IMAGE | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ==========================================
  # Job 6: Dockerfile Lint Ê£ÄÊü•ÔºàÂèØÈÄâÔºâ
  # ==========================================
  dockerfile-lint:
    name: Dockerfile Lint Check
    runs-on: ubuntu-latest
    if: false  # ÊöÇÊó∂Á¶ÅÁî®ÔºåÈúÄË¶ÅÊó∂Êîπ‰∏∫ true

    strategy:
      matrix:
        service:
          - gamevault-gateway
          - gamevault-auth
          - gamevault-shopping
          - gamevault-forum
          - gamevault-developer
          - gamevault-social

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./${{ matrix.service }}/Dockerfile
          failure-threshold: error  # Âè™Êúâ error Á∫ßÂà´ÊâçÂ§±Ë¥•Ôºåwarning ‰∏çÂΩ±Âìç
          format: sarif
          output-file: hadolint-${{ matrix.service }}.sarif
        continue-on-error: true  # Âç≥‰ΩøÂ§±Ë¥•‰πüÁªßÁª≠

      - name: Upload Hadolint results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request'
        continue-on-error: true
        with:
          sarif_file: hadolint-${{ matrix.service }}.sarif
          category: hadolint-${{ matrix.service }}

  # ==========================================
  # Job 7: ÂÆπÂô®Êâ´ÊèèÊ±áÊÄªÊä•Âëä
  # ==========================================
  container-scan-summary:
    name: Container Scan Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan, docker-scout-scan]  # ÁßªÈô§ dockerfile-lint
    if: always()

    steps:
      - name: Download all scan reports
        uses: actions/download-artifact@v4
        with:
          path: scan-reports

      - name: Generate Summary Report
        run: |
          echo "# üê≥ Container Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Êâ´ÊèèÂÆåÊàêÊÉÖÂÜµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Êâ´ÊèèÈ°πÁõÆ | Áä∂ÊÄÅ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Scan | ${{ needs.trivy-scan.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Scout | ${{ needs.docker-scout-scan.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ÁªüËÆ°ÊâÄÊúâÊúçÂä°ÁöÑÊºèÊ¥ûÊÄªÊï∞
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          
          for json_file in scan-reports/trivy-report-*/trivy-*.json; do
            if [ -f "$json_file" ]; then
              CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$json_file" || echo "0")
              HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$json_file" || echo "0")
              MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$json_file" || echo "0")
          
              TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
              TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + MEDIUM))
            fi
          done
          
          echo "## üîç Overall Vulnerability Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Total Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Critical | $TOTAL_CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| üü† High | $TOTAL_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Medium | $TOTAL_MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL_CRITICAL" -gt 0 ]; then
            echo "‚ö†Ô∏è **ÂèëÁé∞ $TOTAL_CRITICAL ‰∏™‰∏•ÈáçÊºèÊ¥ûÔºåÈúÄË¶ÅÁ´ãÂç≥Â§ÑÁêÜ!**" >> $GITHUB_STEP_SUMMARY
          elif [ "$TOTAL_HIGH" -gt 0 ]; then
            echo "‚ö†Ô∏è **ÂèëÁé∞ $TOTAL_HIGH ‰∏™È´òÂç±ÊºèÊ¥ûÔºåËØ∑Â∞ΩÂø´‰øÆÂ§ç„ÄÇ**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Êú™ÂèëÁé∞‰∏•ÈáçÊàñÈ´òÂç±ÊºèÊ¥û„ÄÇ**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Consolidated Report
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-summary
          path: scan-reports/
          retention-days: 90